import streamlit as st
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestRegressor
import plotly.express as px

# --- 1. ãƒšãƒ¼ã‚¸æ§‹æˆ ---
st.set_page_config(page_title="MSAILab AI Alpha", layout="wide")

st.title("ğŸ›¡ï¸ è³‡ç”£é‹ç”¨AIè§£æåŸºç›¤ï¼šMSAI-Alpha v1.5")
st.write("ğŸ“Š çµ±åˆåˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 2026/01/16 æœ€æ–°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ¸ˆã¿")
st.markdown("---")

# --- 2. ç‹¬è‡ªç›£è¦–ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (å¤©æ°—ãƒ»ç†ç”±ãƒ»35ç¤¾) ---
@st.cache_data
def get_integrated_database():
    # æ¥­ç•Œå¤©æ°—å›³ã®å®šç¾©: â˜€ï¸(å¥½èª¿), â˜ï¸(ä¸é€æ˜), â˜”(è‹¦æˆ¦)
    data = [
        # å•†ç¤¾
        {'Ticker': '8058.T', 'éŠ˜æŸ„å': 'ä¸‰è±å•†äº‹', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 15.5, 'åˆ©å›ã‚Š': 3.5, 'é…å½“æ€§å‘': 25.0, 'æ ªä¾¡': 2860.0},
        {'Ticker': '8001.T', 'éŠ˜æŸ„å': 'ä¼Šè—¤å¿ å•†äº‹', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 17.0, 'åˆ©å›ã‚Š': 3.1, 'é…å½“æ€§å‘': 28.0, 'æ ªä¾¡': 6620.0},
        {'Ticker': '8031.T', 'éŠ˜æŸ„å': 'ä¸‰äº•ç‰©ç”£', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 15.0, 'åˆ©å›ã‚Š': 3.2, 'é…å½“æ€§å‘': 28.0, 'æ ªä¾¡': 3100.0},
        {'Ticker': '8053.T', 'éŠ˜æŸ„å': 'ä½å‹å•†äº‹', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 12.0, 'åˆ©å›ã‚Š': 4.1, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 3300.0},
        {'Ticker': '8002.T', 'éŠ˜æŸ„å': 'ä¸¸ç´…', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 14.5, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 25.0, 'æ ªä¾¡': 2450.0},
        # ãŸã°ã“ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼
        {'Ticker': '2914.T', 'éŠ˜æŸ„å': 'æ—¥æœ¬ãŸã°ã“ç”£æ¥­', 'å¤©æ°—': 'â˜ï¸', 'ROE': 16.2, 'åˆ©å›ã‚Š': 6.2, 'é…å½“æ€§å‘': 75.0, 'æ ªä¾¡': 4150.0},
        {'Ticker': '9513.T', 'éŠ˜æŸ„å': 'é›»æºé–‹ç™º', 'å¤©æ°—': 'â˜ï¸', 'ROE': 7.5, 'åˆ©å›ã‚Š': 4.2, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 2450.0},
        {'Ticker': '1605.T', 'éŠ˜æŸ„å': 'INPEX', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 10.2, 'åˆ©å›ã‚Š': 4.0, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 2100.0},
        # é€šä¿¡
        {'Ticker': '9432.T', 'éŠ˜æŸ„å': 'NTT', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 12.5, 'åˆ©å›ã‚Š': 3.2, 'é…å½“æ€§å‘': 35.0, 'æ ªä¾¡': 180.5},
        {'Ticker': '9433.T', 'éŠ˜æŸ„å': 'KDDI', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 13.5, 'åˆ©å›ã‚Š': 4.0, 'é…å½“æ€§å‘': 42.0, 'æ ªä¾¡': 4850.0},
        {'Ticker': '9434.T', 'éŠ˜æŸ„å': 'ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 18.0, 'åˆ©å›ã‚Š': 5.2, 'é…å½“æ€§å‘': 85.0, 'æ ªä¾¡': 195.0},
        # é‡‘è
        {'Ticker': '8306.T', 'éŠ˜æŸ„å': 'ä¸‰è±UFJ', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 8.5, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 38.0, 'æ ªä¾¡': 1460.0},
        {'Ticker': '8316.T', 'éŠ˜æŸ„å': 'ä¸‰äº•ä½å‹', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 8.0, 'åˆ©å›ã‚Š': 4.0, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 8850.0},
        {'Ticker': '8591.T', 'éŠ˜æŸ„å': 'ã‚ªãƒªãƒƒã‚¯ã‚¹', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 9.8, 'åˆ©å›ã‚Š': 4.3, 'é…å½“æ€§å‘': 33.0, 'æ ªä¾¡': 3240.0},
        {'Ticker': '8766.T', 'éŠ˜æŸ„å': 'æ±äº¬æµ·ä¸ŠHD', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 14.0, 'åˆ©å›ã‚Š': 3.6, 'é…å½“æ€§å‘': 45.0, 'æ ªä¾¡': 3800.0},
        # ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»å»ºè¨­
        {'Ticker': '7203.T', 'éŠ˜æŸ„å': 'ãƒˆãƒ¨ã‚¿', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 11.5, 'åˆ©å›ã‚Š': 2.8, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 2650.0},
        {'Ticker': '1925.T', 'éŠ˜æŸ„å': 'å¤§å’Œãƒã‚¦ã‚¹', 'å¤©æ°—': 'â˜ï¸', 'ROE': 11.2, 'åˆ©å›ã‚Š': 3.5, 'é…å½“æ€§å‘': 35.0, 'æ ªä¾¡': 4200.0},
        {'Ticker': '4063.T', 'éŠ˜æŸ„å': 'ä¿¡è¶ŠåŒ–å­¦', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 18.2, 'åˆ©å›ã‚Š': 1.8, 'é…å½“æ€§å‘': 25.0, 'æ ªä¾¡': 5950.0},
        {'Ticker': '6301.T', 'éŠ˜æŸ„å': 'å°æ¾è£½ä½œæ‰€', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 13.5, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 4200.0},
        {'Ticker': '9101.T', 'éŠ˜æŸ„å': 'æ—¥æœ¬éƒµèˆ¹', 'å¤©æ°—': 'â˜”', 'ROE': 12.0, 'åˆ©å›ã‚Š': 5.1, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 4800.0},
        {'Ticker': '4502.T', 'éŠ˜æŸ„å': 'æ­¦ç”°è–¬å“', 'å¤©æ°—': 'â˜”', 'ROE': 5.5, 'åˆ©å›ã‚Š': 4.8, 'é…å½“æ€§å‘': 95.0, 'æ ªä¾¡': 4100.0},
        {'Ticker': '7751.T', 'éŠ˜æŸ„å': 'ã‚­ãƒ¤ãƒãƒ³', 'å¤©æ°—': 'â˜€ï¸', 'ROE': 9.2, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 50.0, 'æ ªä¾¡': 4100.0},
        {'Ticker': '1801.T', 'éŠ˜æŸ„å': 'å¤§æˆå»ºè¨­', 'å¤©æ°—': 'â˜ï¸', 'ROE': 8.0, 'åˆ©å›ã‚Š': 3.5, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 5100.0},
    ]
    # è¶³ã‚Šãªã„åˆ†ã‚’é©å®œè¿½åŠ ï¼ˆè¨ˆ35éŠ˜æŸ„å‰å¾Œï¼‰
    return pd.DataFrame(data)

# --- 3. AIè§£æãƒ­ã‚¸ãƒƒã‚¯ ---
df = get_integrated_database()

# AIãƒ¢ãƒ‡ãƒ«ï¼ˆRandomForestï¼‰ã®å­¦ç¿’
X = df[['ROE', 'åˆ©å›ã‚Š', 'é…å½“æ€§å‘']]
# å¤©æ°—ã‚¹ã‚³ã‚¢ã‚’æ•°å€¤åŒ–ã—ã¦ãƒ¢ãƒ‡ãƒ«ã«åæ˜ ï¼ˆâ˜€ï¸=1.0, â˜ï¸=0.5, â˜”=0.0ï¼‰
weather_map = {'â˜€ï¸': 1.0, 'â˜ï¸': 0.5, 'â˜”': 0.0}
weather_val = df['å¤©æ°—'].map(weather_map)
y_target = (df['ROE'] * 0.3) + (df['åˆ©å›ã‚Š'] * 0.4) - (df['é…å½“æ€§å‘'] * 0.1) + (weather_val * 2.0)

model = RandomForestRegressor(n_estimators=100, random_state=42)
model.fit(X, y_target)
df['AIã‚¹ã‚³ã‚¢'] = model.predict(X)

# åˆ¤å®šç†ç”±ã®è‡ªå‹•ç”Ÿæˆé–¢æ•°
def generate_rationale(row):
    reasons = []
    if row['ROE'] >= 12.0: reasons.append("é«˜åç›Šæ€§")
    if row['åˆ©å›ã‚Š'] >= 4.0: reasons.append("åˆ©å›ã‚Šå„ªä½")
    if row['é…å½“æ€§å‘'] <= 40.0: reasons.append("ä½™åŠ›ååˆ†")
    if row['å¤©æ°—'] == 'â˜€ï¸': reasons.append("æ¥­ç•Œå¥½è»¢")
    return "ï¼‹".join(reasons) if reasons else "æ¨™æº–è©•ä¾¡"

df['åˆ¤å®šç†ç”±'] = df.apply(generate_rationale, axis=1)

# --- 4. ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š ---
st.sidebar.header("âš™ï¸ è§£æãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿")
min_roe = st.sidebar.slider("è¦æ±‚ROE (ä¸‹é™ %)", 0.0, 20.0, 7.0)
min_yield = st.sidebar.slider("æœŸå¾…åˆ©å›ã‚Š (ä¸‹é™ %)", 0.0, 8.0, 3.5)
max_payout = st.sidebar.slider("è¨±å®¹é…å½“æ€§å‘ (ä¸Šé™ %)", 0.0, 100.0, 90.0)

# --- 5. è§£æçµæœè¡¨ç¤º ---
final_df = df[
    (df['ROE'] >= min_roe) & (df['åˆ©å›ã‚Š'] >= min_yield) & (df['é…å½“æ€§å‘'] <= max_payout)
].sort_values(by='AIã‚¹ã‚³ã‚¢', ascending=False)

st.subheader(f"ğŸ“ˆ AIè§£æãƒ»ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°çµæœ ({len(final_df)}ç¤¾ è©²å½“)")

# ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
st.dataframe(
    final_df[['Ticker', 'éŠ˜æŸ„å', 'å¤©æ°—', 'ROE', 'åˆ©å›ã‚Š', 'é…å½“æ€§å‘', 'æ ªä¾¡', 'AIã‚¹ã‚³ã‚¢', 'åˆ¤å®šç†ç”±']]
    .style.background_gradient(subset=['AIã‚¹ã‚³ã‚¢'], cmap='Greens')
    .format({'ROE': '{:.1f}', 'åˆ©å›ã‚Š': '{:.1f}', 'é…å½“æ€§å‘': '{:.1f}', 'æ ªä¾¡': 'Â¥{:,.1f}', 'AIã‚¹ã‚³ã‚¢': '{:.1f}'}),
    height=600, use_container_width=True, hide_index=True # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’éš ã™
)

# ã‚°ãƒ©ãƒ•
st.markdown("---")
if not final_df.empty:
    fig = px.bar(final_df.head(15), x='éŠ˜æŸ„å', y='AIã‚¹ã‚³ã‚¢', color='åˆ©å›ã‚Š', 
                 title="AIæ¨å¥¨åº¦ï¼šä¸Šä½15éŠ˜æŸ„æ¯”è¼ƒ", text_auto='.1f')
    st.plotly_chart(fig, use_container_width=True)

# --- 6. ä¼šç¤¾æƒ…å ± (ä¸€ç•ªä¸‹ã«å›ºå®šè¡¨ç¤º) ---
st.markdown("---")
st.subheader("ğŸ¢ äº‹æ¥­é‹å–¶ä¸»ä½“ãƒ»å®Ÿæ…‹è¨¼æ˜")
info_1, info_2, info_3 = st.columns(3)

with info_1:
    st.markdown("**ã€çµ„ç¹”æ¦‚è¦ã€‘**\n\n**æ³•äººå:** MSAILabåˆåŒä¼šç¤¾\n\n**ä»£è¡¨:** ä»£è¡¨å–ç· å½¹ [ã‚ãªãŸã®æ°å]\n\n**è¨­ç«‹:** 2026å¹´1æœˆ15æ—¥")
with info_2:
    st.markdown("**ã€æŠ€è¡“èƒŒæ™¯ã€‘**\n\n**Model:** Random Forest (Scikit-learn)\n\n**Logic:** è²¡å‹™æŒ‡æ¨™ + æ¥­ç•Œå‹•å‘ã®å¤šè§’è§£æ\n\n**çŸ¥è¦‹:** æ ªå¼ä¼šç¤¾ãƒ€ã‚¤ãƒ•ã‚¯ã§ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢çµŒé¨“ã‚’å¿œç”¨")
with info_3:
    st.markdown("**ã€äº‹æ¥­å†…å®¹ã€‘**\n\nå›½å†…ä¸»è¦éŠ˜æŸ„ã‚’å¯¾è±¡ã¨ã—ãŸAIã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã«åŸºã¥ãè‡ªå·±è³‡é‡‘é‹ç”¨äº‹æ¥­ã€‚20å¹´ä»¥ä¸Šã®å¸‚å ´çµŒé¨“ã‚’ã‚·ã‚¹ãƒ†ãƒ åŒ–ã—ãŸç‹¬è‡ªãƒ¢ãƒ‡ãƒ«ã‚’æ¡ç”¨ã€‚")

st.caption("â€»æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯è‡ªå·±å‹˜å®šå–å¼•å°‚ç”¨ã§ã‚ã‚Šã€å¤–éƒ¨ã¸ã®æŠ•è³‡åŠ©è¨€ç­‰ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“ã€‚")
