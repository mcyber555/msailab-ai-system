import streamlit as st
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestRegressor
import plotly.express as px
from datetime import datetime

# --- 1. ãƒšãƒ¼ã‚¸æ§‹æˆ (éŠ€è¡Œå¯©æŸ»ç”¨ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«è¨­å®š) ---
st.set_page_config(page_title="MSAILab AI Asset Management", layout="wide")

# ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢
st.title("ğŸ›¡ï¸ è³‡ç”£é‹ç”¨AIè§£æåŸºç›¤ï¼šMSAI-Alpha v1.4")
st.write(f"æœ€çµ‚è§£ææ—¥: 2026å¹´01æœˆ15æ—¥ (å¤§å¼•ã‘) | ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æ­£å¸¸ç¨¼åƒä¸­")
st.markdown("---")

# --- 2. ç‹¬è‡ªç›£è¦–ãƒ¦ãƒ‹ãƒãƒ¼ã‚¹ (35ç¤¾ãƒ»è²¡å‹™å¥å…¨æ€§é‡è¦–ãƒªã‚¹ãƒˆ) ---
# éŠ€è¡Œå¯©æŸ»ã«è€ãˆã†ã‚‹å®Ÿåœ¨ã®å„ªè‰¯éŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿
@st.cache_data
def get_analysis_database():
    data = [
        # äº”å¤§å•†ç¤¾ (æœ€ä¸Šä½ã«é…ç½®)
        {'Ticker': '8058.T', 'éŠ˜æŸ„å': 'ä¸‰è±å•†äº‹', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'å¸å£²æ¥­', 'ROE': 15.5, 'åˆ©å›ã‚Š': 3.5, 'é…å½“æ€§å‘': 25.0, 'æ ªä¾¡': 2860.0},
        {'Ticker': '8001.T', 'éŠ˜æŸ„å': 'ä¼Šè—¤å¿ å•†äº‹', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'å¸å£²æ¥­', 'ROE': 17.0, 'åˆ©å›ã‚Š': 3.1, 'é…å½“æ€§å‘': 28.0, 'æ ªä¾¡': 6620.0},
        {'Ticker': '8031.T', 'éŠ˜æŸ„å': 'ä¸‰äº•ç‰©ç”£', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'å¸å£²æ¥­', 'ROE': 15.0, 'åˆ©å›ã‚Š': 3.2, 'é…å½“æ€§å‘': 28.0, 'æ ªä¾¡': 3100.0},
        {'Ticker': '8053.T', 'éŠ˜æŸ„å': 'ä½å‹å•†äº‹', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'å¸å£²æ¥­', 'ROE': 12.0, 'åˆ©å›ã‚Š': 4.1, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 3300.0},
        {'Ticker': '8002.T', 'éŠ˜æŸ„å': 'ä¸¸ç´…', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'å¸å£²æ¥­', 'ROE': 14.5, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 25.0, 'æ ªä¾¡': 2450.0},
        
        # ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ»ãŸã°ã“ (æŒ‡å®šéŠ˜æŸ„)
        {'Ticker': '2914.T', 'éŠ˜æŸ„å': 'æ—¥æœ¬ãŸã°ã“ç”£æ¥­(JT)', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'é£Ÿæ–™å“', 'ROE': 16.2, 'åˆ©å›ã‚Š': 6.2, 'é…å½“æ€§å‘': 75.0, 'æ ªä¾¡': 4150.0},
        {'Ticker': '9513.T', 'éŠ˜æŸ„å': 'é›»æºé–‹ç™º(J-POWER)', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'é›»æ°—ãƒ»ã‚¬ã‚¹', 'ROE': 7.5, 'åˆ©å›ã‚Š': 4.2, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 2450.0},
        {'Ticker': '1605.T', 'éŠ˜æŸ„å': 'INPEX', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'é‰±æ¥­', 'ROE': 10.2, 'åˆ©å›ã‚Š': 4.0, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 2100.0},
        
        # é€šä¿¡ãƒ»IT
        {'Ticker': '9432.T', 'éŠ˜æŸ„å': 'æ—¥æœ¬é›»ä¿¡é›»è©±(NTT)', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'æƒ…å ±é€šä¿¡', 'ROE': 12.5, 'åˆ©å›ã‚Š': 3.2, 'é…å½“æ€§å‘': 35.0, 'æ ªä¾¡': 180.5},
        {'Ticker': '9433.T', 'éŠ˜æŸ„å': 'KDDI', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'æƒ…å ±é€šä¿¡', 'ROE': 13.5, 'åˆ©å›ã‚Š': 4.0, 'é…å½“æ€§å‘': 42.0, 'æ ªä¾¡': 4850.0},
        {'Ticker': '9434.T', 'éŠ˜æŸ„å': 'ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'æƒ…å ±é€šä¿¡', 'ROE': 18.0, 'åˆ©å›ã‚Š': 5.2, 'é…å½“æ€§å‘': 85.0, 'æ ªä¾¡': 195.0},
        
        # é‡‘èãƒ»ãƒªãƒ¼ã‚¹
        {'Ticker': '8306.T', 'éŠ˜æŸ„å': 'ä¸‰è±UFJ', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'éŠ€è¡Œæ¥­', 'ROE': 8.5, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 38.0, 'æ ªä¾¡': 1460.0},
        {'Ticker': '8316.T', 'éŠ˜æŸ„å': 'ä¸‰äº•ä½å‹', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'éŠ€è¡Œæ¥­', 'ROE': 8.0, 'åˆ©å›ã‚Š': 4.0, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 8850.0},
        {'Ticker': '8591.T', 'éŠ˜æŸ„å': 'ã‚ªãƒªãƒƒã‚¯ã‚¹', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'ãã®ä»–é‡‘è', 'ROE': 9.8, 'åˆ©å›ã‚Š': 4.3, 'é…å½“æ€§å‘': 33.0, 'æ ªä¾¡': 3240.0},
        {'Ticker': '8766.T', 'éŠ˜æŸ„å': 'æ±äº¬æµ·ä¸ŠHD', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'ä¿é™ºæ¥­', 'ROE': 14.0, 'åˆ©å›ã‚Š': 3.6, 'é…å½“æ€§å‘': 45.0, 'æ ªä¾¡': 3800.0},
        
        # å»ºè¨­ãƒ»ä½å®…ãƒ»åŒ–å­¦ãƒ»æ©Ÿæ¢°
        {'Ticker': '1925.T', 'éŠ˜æŸ„å': 'å¤§å’Œãƒã‚¦ã‚¹', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'å»ºè¨­æ¥­', 'ROE': 11.2, 'åˆ©å›ã‚Š': 3.5, 'é…å½“æ€§å‘': 35.0, 'æ ªä¾¡': 4200.0},
        {'Ticker': '1928.T', 'éŠ˜æŸ„å': 'ç©æ°´ãƒã‚¦ã‚¹', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'å»ºè¨­æ¥­', 'ROE': 10.8, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 3250.0},
        {'Ticker': '4063.T', 'éŠ˜æŸ„å': 'ä¿¡è¶ŠåŒ–å­¦', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'åŒ–å­¦', 'ROE': 18.2, 'åˆ©å›ã‚Š': 1.8, 'é…å½“æ€§å‘': 25.0, 'æ ªä¾¡': 5950.0},
        {'Ticker': '6301.T', 'éŠ˜æŸ„å': 'å°æ¾è£½ä½œæ‰€', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'æ©Ÿæ¢°', 'ROE': 13.5, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 4200.0},
        {'Ticker': '7203.T', 'éŠ˜æŸ„å': 'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'è¼¸é€ç”¨æ©Ÿå™¨', 'ROE': 11.5, 'åˆ©å›ã‚Š': 2.8, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 2650.0},
        
        # æµ·é‹ãƒ»ãã®ä»–
        {'Ticker': '9101.T', 'éŠ˜æŸ„å': 'æ—¥æœ¬éƒµèˆ¹', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'æµ·é‹æ¥­', 'ROE': 12.0, 'åˆ©å›ã‚Š': 5.1, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 4800.0},
        {'Ticker': '9104.T', 'éŠ˜æŸ„å': 'å•†èˆ¹ä¸‰äº•', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'æµ·é‹æ¥­', 'ROE': 11.5, 'åˆ©å›ã‚Š': 5.2, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 4650.0},
        {'Ticker': '7751.T', 'éŠ˜æŸ„å': 'ã‚­ãƒ¤ãƒãƒ³', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'é›»æ°—æ©Ÿå™¨', 'ROE': 9.2, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 50.0, 'æ ªä¾¡': 4100.0},
    ]
    # è¶³ã‚Šãªã„åˆ†ã‚’ã•ã‚‰ã«å„ªè‰¯éŠ˜æŸ„ã§è£œå®Œã—35ç¤¾è¦æ¨¡ã«ã€‚
    ext = [
        {'Ticker': '8411.T', 'éŠ˜æŸ„å': 'ã¿ãšã»FG', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'éŠ€è¡Œæ¥­', 'ROE': 7.2, 'åˆ©å›ã‚Š': 3.7, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 3150.0},
        {'Ticker': '8725.T', 'éŠ˜æŸ„å': 'MS&AD', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'ä¿é™ºæ¥­', 'ROE': 9.5, 'åˆ©å›ã‚Š': 4.2, 'é…å½“æ€§å‘': 50.0, 'æ ªä¾¡': 2850.0},
        {'Ticker': '8308.T', 'éŠ˜æŸ„å': 'ã‚ŠããªHD', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'éŠ€è¡Œæ¥­', 'ROE': 6.5, 'åˆ©å›ã‚Š': 4.1, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 950.0},
        {'Ticker': '1801.T', 'éŠ˜æŸ„å': 'å¤§æˆå»ºè¨­', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'å»ºè¨­æ¥­', 'ROE': 8.0, 'åˆ©å›ã‚Š': 3.5, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 5100.0},
        {'Ticker': '1802.T', 'éŠ˜æŸ„å': 'å¤§æ—çµ„', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'å»ºè¨­æ¥­', 'ROE': 8.2, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 1400.0},
        {'Ticker': '1803.T', 'éŠ˜æŸ„å': 'æ¸…æ°´å»ºè¨­', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'å»ºè¨­æ¥­', 'ROE': 7.5, 'åˆ©å›ã‚Š': 3.6, 'é…å½“æ€§å‘': 40.0, 'æ ªä¾¡': 980.0},
        {'Ticker': '4503.T', 'éŠ˜æŸ„å': 'ã‚¢ã‚¹ãƒ†ãƒ©ã‚¹è£½è–¬', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'åŒ»è–¬å“', 'ROE': 10.5, 'åˆ©å›ã‚Š': 4.2, 'é…å½“æ€§å‘': 55.0, 'æ ªä¾¡': 1780.0},
        {'Ticker': '7267.T', 'éŠ˜æŸ„å': 'ãƒ›ãƒ³ãƒ€', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'è¼¸é€ç”¨æ©Ÿå™¨', 'ROE': 8.5, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 1600.0},
        {'Ticker': '5108.T', 'éŠ˜æŸ„å': 'ãƒ–ãƒªãƒ‚ã‚¹ãƒˆãƒ³', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'ã‚´ãƒ è£½å“', 'ROE': 10.5, 'åˆ©å›ã‚Š': 3.8, 'é…å½“æ€§å‘': 45.0, 'æ ªä¾¡': 6500.0},
        {'Ticker': '8604.T', 'éŠ˜æŸ„å': 'é‡æ‘HD', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'è¨¼åˆ¸æ¥­', 'ROE': 5.2, 'åˆ©å›ã‚Š': 3.5, 'é…å½“æ€§å‘': 50.0, 'æ ªä¾¡': 850.0},
        {'Ticker': '2502.T', 'éŠ˜æŸ„å': 'ã‚¢ã‚µãƒ’ã‚°ãƒ«ãƒ¼ãƒ—', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'é£Ÿæ–™å“', 'ROE': 9.5, 'åˆ©å›ã‚Š': 2.5, 'é…å½“æ€§å‘': 30.0, 'æ ªä¾¡': 5500.0},
        {'Ticker': '4188.T', 'éŠ˜æŸ„å': 'ä¸‰è±ã‚±ãƒŸã‚«ãƒ«', 'ã‚»ã‚¯ã‚¿ãƒ¼': 'åŒ–å­¦', 'ROE': 7.0, 'åˆ©å›ã‚Š': 4.0, 'é…å½“æ€§å‘': 50.0, 'æ ªä¾¡': 900.0},
    ]
    return pd.DataFrame(data + ext)

# --- 3. è§£æã‚¨ãƒ³ã‚¸ãƒ³ (æ©Ÿæ¢°å­¦ç¿’) ---
# éŠ€è¡Œã¸æå‡ºã—ãŸã€ŒROEãƒ»åˆ©å›ã‚Šãƒ»é…å½“æ€§å‘ã®ç›¸é–¢åˆ†æã€ã‚’ãƒ­ã‚¸ãƒƒã‚¯åŒ–
with st.spinner('ğŸš€ AIè§£æã‚¨ãƒ³ã‚¸ãƒ³ç¨¼åƒä¸­... (Random Forest Model)'):
    df = get_analysis_database()
    X = df[['ROE', 'åˆ©å›ã‚Š', 'é…å½“æ€§å‘']]
    # 20å¹´ã®çµŒé¨“ã«åŸºã¥ãé‡ã¿ä»˜ã‘ï¼šROE(åç›Šæ€§)ã¨åˆ©å›ã‚Š(é‚„å…ƒ)ã‚’é‡è¦–
    y_target = (df['ROE'] * 0.45) + (df['åˆ©å›ã‚Š'] * 0.45) - (df['é…å½“æ€§å‘'] * 0.1)
    
    model = RandomForestRegressor(n_estimators=100, random_state=42)
    model.fit(X, y_target)
    df['AIè§£æã‚¹ã‚³ã‚¢'] = model.predict(X)

# --- 4. ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ---
st.sidebar.header("âš™ï¸ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è¨­å®š")
min_roe = st.sidebar.slider("è¦æ±‚ROE (%)", 0.0, 20.0, 7.0)
min_yield = st.sidebar.slider("åˆ©å›ã‚Šä¸‹é™ (%)", 0.0, 8.0, 3.5)
max_payout = st.sidebar.slider("è¨±å®¹é…å½“æ€§å‘ (%)", 0.0, 100.0, 90.0)

# --- 5. è§£æçµæœã®è¡¨ç¤º ---
final_df = df[
    (df['ROE'] >= min_roe) & (df['åˆ©å›ã‚Š'] >= min_yield) & (df['é…å½“æ€§å‘'] <= max_payout)
].sort_values(by='AIè§£æã‚¹ã‚³ã‚¢', ascending=False)

st.subheader(f"ğŸ“Š è§£æçµæœ ({len(final_df)}ç¤¾ è©²å½“ / ç›£è¦–ãƒ¦ãƒ‹ãƒãƒ¼ã‚¹ 35ç¤¾)")

col_main, col_chart = st.columns([2, 1])
with col_main:
    st.dataframe(
        final_df[['Ticker', 'éŠ˜æŸ„å', 'ã‚»ã‚¯ã‚¿ãƒ¼', 'ROE', 'åˆ©å›ã‚Š', 'é…å½“æ€§å‘', 'æ ªä¾¡', 'AIè§£æã‚¹ã‚³ã‚¢']]
        .style.background_gradient(subset=['AIè§£æã‚¹ã‚³ã‚¢'], cmap='Greens')
        .format({'AIè§£æã‚¹ã‚³ã‚¢': '{:.1f}', 'æ ªä¾¡': 'Â¥{:,.1f}'}),
        height=600, use_container_width=True
    )

with col_chart:
    if not final_df.empty:
        fig = px.pie(final_df.head(15), values='AIè§£æã‚¹ã‚³ã‚¢', names='éŠ˜æŸ„å', title="AIæ¨å¥¨ãƒ»è³‡ç”£é…åˆ†ãƒ¢ãƒ‡ãƒ«", hole=0.4)
        st.plotly_chart(fig, use_container_width=True)

# --- 6. äº‹æ¥­å†…å®¹ãƒ»ä¼šç¤¾æƒ…å ± (æå‡ºæ›¸é¡ã¨å®Œå…¨ä¸€è‡´) ---
st.markdown("---")
st.subheader("ğŸ¢ äº‹æ¥­é‹å–¶ä¸»ä½“ãƒ»å®Ÿæ…‹è¨¼æ˜")
info_1, info_2, info_3 = st.columns(3)

with info_1:
    st.markdown("""
    **ã€çµ„ç¹”æ¦‚è¦ã€‘** **æ³•äººå:** MSAILabåˆåŒä¼šç¤¾  
    **ä»£è¡¨è€…:** ä»£è¡¨å–ç· å½¹ [ã‚ãªãŸã®æ°å]  
    **è¨­ç«‹:** 2026å¹´1æœˆ15æ—¥  
    **æ‰€åœ¨åœ°:** [ç™»è¨˜ä¸Šã®ä½æ‰€]
    """)

with info_2:
    st.markdown("""
    **ã€æŠ€è¡“èƒŒæ™¯ã€‘** **é–‹ç™ºè¨€èª:** Python / Streamlit  
    **è§£ææ‰‹æ³•:** ãƒ©ãƒ³ãƒ€ãƒ ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ(æ©Ÿæ¢°å­¦ç¿’)  
    **çŸ¥è¦‹:** æ ªå¼ä¼šç¤¾ãƒ€ã‚¤ãƒ•ã‚¯ã§ã®ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰çŸ¥è¦‹ã€ãŠã‚ˆã³20å¹´ä»¥ä¸Šã®å¸‚å ´é‹ç”¨çµŒé¨“ã€‚
    """)

with info_3:
    st.markdown("""
    **ã€äº‹æ¥­å†…å®¹ã€‘** å›½å†…ä¸»è¦éŠ˜æŸ„ã‚’å¯¾è±¡ã«ã€è²¡å‹™å¥å…¨æ€§ã¨å¢—é…å¯èƒ½æ€§ã‚’ç‹¬è‡ªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã€‚è‡ªå·±å‹˜å®šï¼ˆProp-Tradingï¼‰ã«ã‚ˆã‚‹ä¸­é•·æœŸã®è³‡ç”£é‹ç”¨ã‚’æœ€é©åŒ–ã€‚
    """)

st.caption("â€»æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯è‡ªå·±å‹˜å®šå–å¼•å°‚ç”¨ã§ã‚ã‚Šã€å¤–éƒ¨ã¸ã®æŠ•è³‡å‹§èª˜ãƒ»åŠ©è¨€ãƒ»è³‡é‡‘é è¨—ã®å—ã‘å…¥ã‚Œã¯ä¸€åˆ‡è¡Œã£ã¦ãŠã‚Šã¾ã›ã‚“ã€‚")
